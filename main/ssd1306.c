#include "ssd1306.h"
#include "i2c_master.h"
#include <string.h>

#define SSD1306_ADDR 0x3C
#define SSD1306_CMD  0x00
#define SSD1306_DATA 0x40

static uint8_t oled_buffer[8][128];

// FONT 8x8 â€“ cyfry i kilka liter
static const uint8_t font8x8_basic[][8] = {
    {0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00}, //0
    {0x18,0x38,0x18,0x18,0x18,0x18,0x3C,0x00}, //1
    {0x3C,0x66,0x06,0x0C,0x30,0x60,0x7E,0x00}, //2
    {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00}, //3
    {0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00}, //4
    {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00}, //5
    {0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00}, //6
    {0x7E,0x66,0x06,0x0C,0x18,0x18,0x18,0x00}, //7
    {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00}, //8
    {0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00}, //9
    {0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x00}, //T
    {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00}, //H
    {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00}, //C
    {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00}, //P
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x00,0x00}, //h
    {0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00,0x00}, //a
    {0x62,0x64,0x08,0x10,0x26,0x46,0x00,0x00}, //%
    {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00}, //:
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, //.
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}  //space
};

static int char_to_index(char c){
    if(c>='0' && c<='9') return c-'0';
    switch(c){
        case 'T': return 10;
        case 'H': return 11;
        case 'C': return 12;
        case 'P': return 13;
        case 'h': return 14;
        case 'a': return 15;
        case '%': return 16;
        case ':': return 17;
        case '.': return 18;
        case ' ': return 19;
        default: return 19;
    }
}

static void ssd1306_send_cmd(uint8_t cmd){
    i2c_write_reg(SSD1306_ADDR, SSD1306_CMD, cmd);
}

void ssd1306_init(void){
    ssd1306_send_cmd(0xAE); // display off
    ssd1306_send_cmd(0xA0); // segment remap normal
    ssd1306_send_cmd(0xC0); // COM scan direction normal
    ssd1306_send_cmd(0x20); // memory mode
    ssd1306_send_cmd(0x00); // horizontal addressing
    ssd1306_send_cmd(0xAF); // display on
    memset(oled_buffer,0,sizeof(oled_buffer));
}

void ssd1306_clear(void){
    memset(oled_buffer,0,sizeof(oled_buffer));
    for(uint8_t page=0; page<8; page++){
        ssd1306_send_cmd(0xB0 + page);
        ssd1306_send_cmd(0x00);
        ssd1306_send_cmd(0x10);
        for(uint8_t col=0; col<128; col++)
            i2c_write_reg(SSD1306_ADDR, SSD1306_DATA, 0x00);
    }
}

void ssd1306_write_char(char c, uint8_t page, uint8_t col){
    if(col>=16) return;
    int idx = char_to_index(c);
    memcpy(&oled_buffer[page][col*8], font8x8_basic[idx], 8);
}

void ssd1306_write_string(const char* str, uint8_t page){
    uint8_t col=0;
    while(*str && col<16){
        ssd1306_write_char(*str,page,col);
        str++; col++;
    }

    ssd1306_send_cmd(0xB0 + page);
    ssd1306_send_cmd(0x00);
    ssd1306_send_cmd(0x10);
    for(uint8_t i=0;i<128;i++)
        i2c_write_reg(SSD1306_ADDR, SSD1306_DATA, oled_buffer[page][i]);
}
